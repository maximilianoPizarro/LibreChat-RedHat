schemaVersion: 2.3.0
metadata:
  name: redhat-chat
  displayName: Red Hat Chat
  description: Red Hat Chat - Tech Preview with LibreChat and Red Hat Design System
  tags:
    - nodejs
    - chat
    - ai
    - redhat
  projectType: nodejs
  language: typescript
  version: 0.8.1-rc2
  attributes:
    tech-preview: "true"
components:
  # Main container for both OpenShift CLI and Node.js tasks
  # Uses base developer image (includes oc, kubectl) - Node.js will be installed via init-workspace-full
  - name: api
    container:
      image: quay.io/devfile/base-developer-image:ubi9-latest
      memoryLimit: 2Gi
      cpuLimit: 1000m
      cpuRequest: 250m
      endpoints:
        - name: http
          targetPort: 3080
          exposure: public
          protocol: http
          path: /
        - name: api-internal
          targetPort: 3080
          exposure: none
          protocol: http
          path: /
      env:
        - name: NODE_ENV
          value: development
        - name: HOST
          value: 0.0.0.0
        - name: PORT
          value: "3080"
        - name: DOMAIN
          value: http://localhost:3080
        - name: MONGO_URI
          value: mongodb://127.0.0.1:27017/LibreChat
        - name: MEILI_HOST
          value: http://127.0.0.1:7700
        - name: MEILI_MASTER_KEY
          value: librechat
        - name: MEILI_NO_ANALYTICS
          value: "true"
        - name: SEARCH
          value: "true"
        # RAG API is optional - uncomment vectordb and rag-api components to enable
        # - name: RAG_API_URL
        #   value: http://rag-api:8000
        # - name: RAG_PORT
        #   value: "8000"
        # JWT Secrets - generate secure values for production
        - name: JWT_SECRET
          value: 8a447c316c171f5df8e304c085187b6d10e4eeef5174137d4ad4d2cdd956f5e7
        - name: JWT_REFRESH_SECRET
          value: 83096493d70e22561f84191c24f459d72e9b41f4c8657fe43aae8cb9b0fe1fa4
        - name: JWT_EXPIRES_IN
          value: 1d
        - name: JWT_REFRESH_EXPIRES_IN
          value: 7d
        # Authentication settings
        - name: ALLOW_EMAIL_LOGIN
          value: "true"
        - name: ALLOW_REGISTRATION
          value: "true"
        - name: ALLOW_SOCIAL_LOGIN
          value: "true"
        # OpenID/OAuth configuration (optional - uncomment and configure if needed)
        # - name: OPENID_LOGIN_ENABLED
        #   value: "true"
        # - name: OPENID_ISSUER
        #   value: https://auth.redhat.com/realms/librechat
        # - name: OPENID_CLIENT_ID
        #   value: client-id
        # - name: OPENID_CLIENT_SECRET
        #   value: client-secret
        # - name: OPENID_SCOPE
        #   value: openid profile email
        # Embeddings (without Ollama - use OpenAI or disable)
        # - name: EMBEDDINGS_PROVIDER
        #   value: openai
        # - name: OPENAI_API_KEY
        #   value: sk-your_openai_api_key_here
      volumeMounts:
        - name: images-data
          path: /app/client/public/images
        - name: uploads-data
          path: /app/uploads
        - name: logs-data
          path: /app/api/logs
      sourceMapping: /
      command:
        - /bin/sh
        - -c
        - |
          # Keep container running
          tail -f /dev/null
  # nodejs component - let parent handle it completely, we don't override
  # The parent will provide Node.js configuration
  - name: mongodb
    container:
      image: docker.io/library/mongo:7.0
      memoryLimit: 512Mi
      endpoints:
        - name: mongodb
          targetPort: 27017
          exposure: internal
          protocol: tcp
      command:
        - mongod
        - --noauth
        - --bind_ip_all
      volumeMounts:
        - name: mongodb-data
          path: /data/db
  - name: meilisearch
    container:
      image: docker.io/getmeili/meilisearch:v1.12.3
      memoryLimit: 512Mi
      endpoints:
        - name: meilisearch
          targetPort: 7700
          exposure: public
          protocol: http
          path: /
      env:
        - name: MEILI_HOST
          value: http://meilisearch:7700
        - name: MEILI_ENV
          value: development
        - name: MEILI_NO_ANALYTICS
          value: "true"
        - name: MEILI_MASTER_KEY
          value: librechat
      volumeMounts:
        - name: meili-data
          path: /meili_data
  # Ollama component - commented out due to resource constraints
  # Uncomment when you have sufficient resources (4Gi+ memory available)
  #- name: ollama
  #  attributes:
  #    container-overrides:
  #      resources:
  #        limits:
  #          cpu: 2000m
  #          memory: 4Gi
  #          # nvidia.com/gpu: 1 # Uncomment this if the pod shall be scheduled only on a GPU node
  #        requests:
  #          cpu: 500m
  #          memory: 2Gi
  #          # nvidia.com/gpu: 1 # Uncomment this if the pod shall be scheduled only on a GPU node
  #  container:
  #    image: docker.io/ollama/ollama:latest
  #    mountSources: true
  #    sourceMapping: /.ollama
  #    endpoints:
  #      - name: ollama
  #        targetPort: 11434
  #        exposure: internal
  #        protocol: http
  #        path: /
  # VectorDB (pgvector) - Required for RAG API functionality
  # Note: VectorDB may have issues in some OpenShift environments
  #- name: vectordb
  #  container:
  #    image: docker.io/pgvector/pgvector:0.8.0-pg15-trixie
  #    memoryLimit: 1Gi
  #    cpuLimit: 500m
  #    endpoints:
  #      - name: postgres
  #        targetPort: 5432
  #        exposure: none
  #        protocol: tcp
  #    env:
  #      - name: POSTGRES_DB
  #        value: mydatabase
  #      - name: POSTGRES_USER
  #        value: myuser
  #      - name: POSTGRES_PASSWORD
  #        value: mypassword
  #    volumeMounts:
  #      - name: pg-data
  #        path: /var/lib/postgresql/data
  # - name: rag-api
  #   container:
  #     image: ghcr.io/danny-avila/librechat-rag-api-dev-lite:latest
  #     memoryLimit: 1Gi
  #     endpoints:
  #       - name: rag-api
  #         targetPort: 8000
  #         exposure: none
  #         protocol: http
  #     env:
  #       - name: DB_HOST
  #         value: vectordb
  #       - name: RAG_PORT
  #         value: "8000"
  #       - name: OPENAI_API_KEY
  #         value: ""
  - name: images-data
    volume:
      size: 1Gi
  - name: uploads-data
    volume:
      size: 1Gi
  - name: logs-data
    volume:
      size: 500Mi
  - name: mongodb-data
    volume:
      size: 2Gi
  - name: meili-data
    volume:
      size: 1Gi
  # pg-data volume for vectordb
  - name: pg-data
    volume:
      size: 1Gi
commands:
  # Custom Node.js tasks - using different names to avoid conflicts with parent
  - id: init-custom
    exec:
      component: api
      commandLine: |
        echo "Initializing Red Hat Chat workspace..."
        # Ensure Node.js is available
        if ! command -v node &> /dev/null; then
          echo "Node.js not found. Please run 'devfile init-workspace-full' first to install Node.js"
          exit 1
        fi
        npm install
  - id: build-custom
    exec:
      component: api
      commandLine: |
        cd /projects/librechat-redhat || cd /projects || pwd
        # Ensure all dependencies are installed first
        echo "Installing/updating dependencies..."
        npm install --legacy-peer-deps || npm install
        # Clean and rebuild packages to ensure peer dependencies are resolved
        echo "Cleaning previous builds..."
        rm -rf packages/client/dist packages/data-provider/dist packages/api/dist packages/data-schemas/dist
        # Build packages in correct order
        echo "Building packages..."
        npm run build:packages
        echo "Building client..."
        npm run build:client
  - id: run-backend
    exec:
      component: api
      commandLine: |
        cd /projects/librechat-redhat || cd /projects || pwd
        # Ensure Node.js is available
        if ! command -v node &> /dev/null; then
          echo "Node.js not found. Please run 'devfile init-workspace-full' first to install Node.js"
          exit 1
        fi
        
        # Wait for MongoDB to be ready
        echo "Waiting for MongoDB to be ready..."
        MAX_ATTEMPTS=30
        ATTEMPT=0
        while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
          # Try multiple methods to check MongoDB connectivity
          if (command -v nc >/dev/null 2>&1 && nc -z 127.0.0.1 27017 2>/dev/null) || \
             (command -v timeout >/dev/null 2>&1 && timeout 2 bash -c "echo > /dev/tcp/127.0.0.1/27017" 2>/dev/null) || \
             (command -v mongosh >/dev/null 2>&1 && mongosh --host 127.0.0.1 --port 27017 --eval "db.adminCommand('ping')" --quiet >/dev/null 2>&1); then
            echo "✓ MongoDB is ready"
            break
          fi
          ATTEMPT=$((ATTEMPT + 1))
          echo "  Attempt $ATTEMPT/$MAX_ATTEMPTS: MongoDB not ready yet, waiting..."
          sleep 2
        done
        if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
          echo "⚠ Warning: MongoDB may not be ready after $MAX_ATTEMPTS attempts"
          echo "  Checking MongoDB container status..."
          echo "  You may need to check if the MongoDB container is running and listening on 0.0.0.0:27017"
          echo "  Continuing anyway, but connection may fail..."
        fi
        
        # Wait for Meilisearch to be ready
        echo "Waiting for Meilisearch to be ready..."
        ATTEMPT=0
        MEILI_READY=false
        while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
          # Try multiple methods to check Meilisearch connectivity
          # First check if port is open
          PORT_OPEN=false
          if command -v nc >/dev/null 2>&1 && nc -z 127.0.0.1 7700 2>/dev/null; then
            PORT_OPEN=true
          elif command -v timeout >/dev/null 2>&1 && timeout 2 bash -c "echo > /dev/tcp/127.0.0.1/7700" 2>/dev/null; then
            PORT_OPEN=true
          fi
          
          # If port is open, check if health endpoint responds
          if [ "$PORT_OPEN" = true ]; then
            if command -v curl >/dev/null 2>&1; then
              # Check health endpoint with proper headers
              # Try health check with master key first, then without
              HEALTH_OK=false
              if curl -s -f -H "Authorization: Bearer librechat" http://127.0.0.1:7700/health >/dev/null 2>&1; then
                HEALTH_OK=true
              elif curl -s -f http://127.0.0.1:7700/health >/dev/null 2>&1; then
                HEALTH_OK=true
              fi
              
              if [ "$HEALTH_OK" = true ]; then
                MEILI_READY=true
                echo "✓ Meilisearch is ready and responding"
                # Give it extra time to fully initialize indexes and be ready for connections
                echo "  Waiting additional 3 seconds for Meilisearch to fully initialize..."
                sleep 3
                break
              fi
            else
              # If curl is not available but port is open, assume it's ready
              MEILI_READY=true
              echo "✓ Meilisearch port is open (health check unavailable)"
              sleep 2
              break
            fi
          fi
          
          ATTEMPT=$((ATTEMPT + 1))
          echo "  Attempt $ATTEMPT/$MAX_ATTEMPTS: Meilisearch not ready yet, waiting..."
          sleep 2
        done
        if [ "$MEILI_READY" = false ]; then
          echo "⚠ Warning: Meilisearch may not be ready after $MAX_ATTEMPTS attempts"
          echo "  Checking Meilisearch container status..."
          echo "  You may need to check if the Meilisearch container is running"
          echo "  Continuing anyway, but connection may fail..."
          echo "  You can disable search by setting SEARCH=false in your environment"
        fi
        
        # Check and install dependencies
        if [ ! -d node_modules ] || [ ! -f node_modules/.bin/cross-env ] || [ ! -d node_modules/winston-daily-rotate-file ] || [ ! -d node_modules/@opentelemetry/exporter-trace-otlp-http ]; then
          echo "Dependencies not fully installed. Installing now..."
          npm install --legacy-peer-deps --workspaces || npm install --legacy-peer-deps || npm install
          if [ $? -ne 0 ]; then
            echo "✗ Failed to install dependencies"
            exit 1
          fi
          # Verify critical dependencies are installed
          MISSING_CRITICAL=""
          if [ ! -d node_modules/winston-daily-rotate-file ] && [ ! -d packages/data-schemas/node_modules/winston-daily-rotate-file ]; then
            MISSING_CRITICAL="$MISSING_CRITICAL winston-daily-rotate-file"
          fi
          if [ ! -d node_modules/@opentelemetry/exporter-trace-otlp-http ]; then
            MISSING_CRITICAL="$MISSING_CRITICAL @opentelemetry/exporter-trace-otlp-http"
          fi
          if [ -n "$MISSING_CRITICAL" ]; then
            echo "⚠ Some critical dependencies are missing: $MISSING_CRITICAL"
            echo "Installing missing dependencies..."
            # Install without --workspaces to avoid npm errors
            for dep in $MISSING_CRITICAL; do
              echo "  Installing $dep..."
              npm install "$dep" --legacy-peer-deps --save || \
              npm install "$dep" --legacy-peer-deps || \
              npm install "$dep"
            done
          fi
        fi
        
        # Check if .env file exists, create from example if missing
        if [ ! -f .env ]; then
          echo "⚠ .env file not found. Creating from env.example.podman..."
          if [ -f env.example.podman ]; then
            cp env.example.podman .env
            echo "✓ .env file created from env.example.podman"
            echo "⚠ Please update .env with your actual configuration values"
          else
            echo "⚠ env.example.podman not found. Please create .env manually"
          fi
        fi
        
        # Check if packages are built
        if [ ! -f packages/data-schemas/dist/index.cjs ] || [ ! -f packages/data-provider/dist/index.cjs ]; then
          echo "Packages not built. Building now..."
          npm run build:packages || {
            echo "⚠ Failed to build packages. Please run 'npm run build:packages' manually"
            exit 1
          }
        fi
        
        # Check if client is built
        if [ ! -f client/dist/index.html ]; then
          echo "Client not built. Building now..."
          echo "This may take a few minutes..."
          cd client
          npm run build || {
            echo "⚠ Failed to build client from client directory"
            cd ..
            npm run build:client || {
              echo "⚠ Failed to build client. Please run 'npm run build:client' manually"
              echo "⚠ Continuing anyway, but the application may not work correctly..."
            }
          }
          cd ..
          # Verify the build was successful
          if [ ! -f client/dist/index.html ]; then
            echo "⚠ Warning: client/dist/index.html still not found after build attempt"
            echo "⚠ The application may not work correctly. Please check build errors above."
          else
            echo "✓ Client built successfully"
          fi
        else
          echo "✓ Client already built"
        fi
        
        echo "Starting backend server..."
        npm run backend:dev
  - id: start-backend
    exec:
      component: api
      commandLine: |
        cd /projects/librechat-redhat || cd /projects || pwd
        # Ensure Node.js is available
        if ! command -v node &> /dev/null; then
          echo "Node.js not found. Please run 'devfile init-workspace-full' first to install Node.js"
          exit 1
        fi
        if [ ! -d node_modules ] || [ ! -f node_modules/.bin/cross-env ]; then
          echo "Dependencies not installed. Installing now..."
          npm install --legacy-peer-deps || npm install
        fi
        npm run backend:dev
  - id: init-workspace
    exec:
      component: api
      commandLine: |
        echo "=========================================="
        echo "Red Hat Chat Workspace Ready!"
        echo "=========================================="
        echo ""
        echo "To initialize dependencies, run:"
        echo "  devfile init-workspace-full"
        echo ""
        echo "To start the backend server, run:"
        echo "  devfile run-backend"
        echo ""
        echo "To deploy to OpenShift, run:"
        echo "  devfile deploy-setup"
        echo "  devfile deploy-run"
        echo "  devfile deploy-expose"
        echo ""
        echo "Current directory: $(pwd 2>/dev/null || echo '/projects')"
        echo "=========================================="
  - id: init-workspace-full
    exec:
      component: api
      commandLine: |
        echo "Initializing workspace with Node.js..."
        cd /projects/librechat-redhat || cd /projects || pwd
        
        # Install Node.js if not available
        if ! command -v node &> /dev/null; then
          echo "Node.js not found. Installing Node.js 20..."
          
          if ! command -v nvm &> /dev/null; then
            echo "Installing nvm (Node Version Manager)..."
            export NVM_DIR="$HOME/.nvm"
            mkdir -p "$NVM_DIR"
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          fi
          
          # Load nvm if available
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          
          if command -v nvm &> /dev/null; then
            echo "Installing Node.js 20 using nvm..."
            nvm install 20
            nvm use 20
            nvm alias default 20
            echo "✓ Node.js installed successfully using nvm"
          elif command -v dnf &> /dev/null; then
            # Try dnf without sudo first (might work if container runs as root or has permissions)
            echo "Trying dnf install (no sudo)..."
            if dnf install -y nodejs npm 2>/dev/null; then
              echo "✓ Node.js installed successfully via dnf"
            else
              echo "⚠ dnf install failed. Trying alternative: download Node.js binary..."
              # Download and install Node.js binary directly (no root required)
              NODE_VERSION="20.11.0"
              ARCH="x64"
              NODE_DISTRO="linux"
              NODE_URL="https://nodejs.org/dist/v${NODE_VERSION}/node-v${NODE_VERSION}-${NODE_DISTRO}-${ARCH}.tar.xz"
              
              echo "Downloading Node.js ${NODE_VERSION}..."
              cd /tmp
              curl -fsSL "$NODE_URL" -o node.tar.xz || {
                echo "✗ Failed to download Node.js"
                echo "Please install Node.js manually or contact your administrator"
                exit 1
              }
              
              echo "Extracting Node.js..."
              tar -xf node.tar.xz || {
                echo "✗ Failed to extract Node.js"
                exit 1
              }
              
              echo "Installing Node.js to ~/.local..."
              mkdir -p ~/.local
              cp -r node-v${NODE_VERSION}-${NODE_DISTRO}-${ARCH}/* ~/.local/
              rm -rf node-v${NODE_VERSION}-${NODE_DISTRO}-${ARCH} node.tar.xz
              
              # Add to PATH
              export PATH="$HOME/.local/bin:$PATH"
              echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc
              echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.profile
              
              echo "✓ Node.js installed successfully to ~/.local"
            fi
          else
            echo "✗ Cannot install Node.js: neither nvm nor dnf available"
            exit 1
          fi
        fi
        
        # Verify Node.js is now available
        if ! command -v node &> /dev/null; then
          echo "✗ Node.js installation failed or not in PATH"
          echo "Please install Node.js manually"
          exit 1
        fi
        
        # Check Node.js version
        NODE_MAJOR=$(node -v | cut -d'v' -f2 | cut -d'.' -f1)
        if [ "$NODE_MAJOR" -lt 20 ]; then
          echo "⚠ Warning: Node.js version is $NODE_MAJOR, but Node.js 20+ is recommended"
          echo "Current version: $(node -v)"
        else
          echo "✓ Node.js version: $(node -v)"
          echo "✓ npm version: $(npm -v)"
        fi
        
        # Install dependencies
        if [ -f package.json ]; then
          echo "Installing dependencies (this may take a few minutes)..."
          # Try with legacy-peer-deps first, then without if it fails
          # Use --workspaces to ensure all workspace dependencies are installed
          if ! npm install --legacy-peer-deps --workspaces; then
            echo "⚠ npm install --legacy-peer-deps --workspaces failed, trying without workspaces flag..."
            if ! npm install --legacy-peer-deps; then
              echo "⚠ npm install --legacy-peer-deps failed, trying without flag..."
              npm install || {
                echo "⚠ npm install had issues. You can retry manually with: npm install"
                # Don't exit with error to allow workspace to start
              }
            fi
          fi
          
          # Verify critical dependencies are installed
          if [ -d node_modules ]; then
            echo "✓ Dependencies installed successfully"
            
            # Check for critical missing dependencies (check in root and workspace packages)
            MISSING_DEPS=""
            if [ ! -d node_modules/winston-daily-rotate-file ] && [ ! -d packages/data-schemas/node_modules/winston-daily-rotate-file ]; then
              MISSING_DEPS="$MISSING_DEPS winston-daily-rotate-file"
            fi
            if [ ! -f node_modules/.bin/cross-env ]; then
              MISSING_DEPS="$MISSING_DEPS cross-env"
            fi
            if [ ! -d node_modules/@opentelemetry/exporter-trace-otlp-http ]; then
              MISSING_DEPS="$MISSING_DEPS @opentelemetry/exporter-trace-otlp-http"
            fi
            
            if [ -n "$MISSING_DEPS" ]; then
              echo "⚠ Some dependencies are missing: $MISSING_DEPS"
              echo "Reinstalling dependencies with workspaces..."
              npm install --legacy-peer-deps --workspaces || npm install --legacy-peer-deps || npm install
            fi
            
            # Build internal packages (required for backend to run)
            echo "Building internal packages..."
            npm run build:packages || {
              echo "⚠ Package build had issues. You can retry manually with: npm run build:packages"
              # Don't exit with error to allow workspace to start
            }
            echo "✓ Packages built successfully"
          else
            echo "✗ node_modules directory not found after installation"
            echo "Please run 'npm install' manually"
          fi
        else
          echo "⚠ package.json not found in $(pwd)"
          echo "Workspace will start, but you may need to navigate to the correct directory"
          # Don't exit with error to allow workspace to start
        fi
        
        # Check if .env file exists, create from example if missing
        if [ ! -f .env ]; then
          echo "⚠ .env file not found. Creating from env.example.podman..."
          if [ -f env.example.podman ]; then
            cp env.example.podman .env
            echo "✓ .env file created from env.example.podman"
            echo "⚠ Please update .env with your actual configuration values (especially MEILI_MASTER_KEY, JWT_SECRET, etc.)"
          else
            echo "⚠ env.example.podman not found. Please create .env manually"
          fi
        else
          echo "✓ .env file exists"
        fi
        
        # Check if librechat.yaml file exists, create from example if missing
        if [ ! -f librechat.yaml ]; then
          echo "⚠ librechat.yaml file not found. Creating from librechat.example.yaml..."
          if [ -f librechat.example.yaml ]; then
            cp librechat.example.yaml librechat.yaml
            echo "✓ librechat.yaml file created from librechat.example.yaml"
            echo "⚠ Please update librechat.yaml with your actual configuration values if needed"
          else
            echo "⚠ librechat.example.yaml not found. Please create librechat.yaml manually"
          fi
        else
          echo "✓ librechat.yaml file exists"
        fi
        
        echo "✓ Workspace initialization completed"
        echo "Run 'devfile run-backend' to start the backend server"
  - id: deploy-setup
    exec:
      component: api
      commandLine: |
        # Use current project/namespace from workspace, or fallback to OPENSHIFT_NAMESPACE
        NAMESPACE=$(oc project -q 2>/dev/null || echo "${OPENSHIFT_NAMESPACE:-maximilianopizarro5-dev}")
        if [ -z "$NAMESPACE" ] || [ "$NAMESPACE" = "default" ]; then
          NAMESPACE=${OPENSHIFT_NAMESPACE:-maximilianopizarro5-dev}
        fi
        echo "Setting up deployment for namespace: $NAMESPACE"
        # Ensure we're in the correct namespace
        oc project $NAMESPACE 2>/dev/null || oc create namespace $NAMESPACE
        if ! oc get secret redhat-chat-secrets -n $NAMESPACE &> /dev/null; then
          JWT_SECRET=$(openssl rand -hex 32)
          JWT_REFRESH_SECRET=$(openssl rand -hex 32)
          MEILI_MASTER_KEY=$(openssl rand -hex 16)
          oc create secret generic redhat-chat-secrets \
            --from-literal=jwt-secret=$JWT_SECRET \
            --from-literal=jwt-refresh-secret=$JWT_REFRESH_SECRET \
            --from-literal=meili-master-key=$MEILI_MASTER_KEY \
            -n $NAMESPACE
          echo "✓ Secrets created"
        else
          echo "✓ Secrets already exist"
        fi
        cd manifests/base && oc apply -k . -n $NAMESPACE && cd ../..
        echo "✓ Base manifests applied"
        oc apply -f .tekton/pipeline.yaml -n $NAMESPACE
        echo "✓ Pipeline created"
  - id: deploy-run
    exec:
      component: api
      commandLine: |
        # Use current project/namespace from workspace
        NAMESPACE=$(oc project -q 2>/dev/null || echo "${OPENSHIFT_NAMESPACE:-maximilianopizarro5-dev}")
        if [ -z "$NAMESPACE" ] || [ "$NAMESPACE" = "default" ]; then
          NAMESPACE=${OPENSHIFT_NAMESPACE:-maximilianopizarro5-dev}
        fi
        PIPELINE_RUN_NAME="redhat-chat-pipeline-run-$(date +%s)"
        cat <<EOF | oc apply -f -
        apiVersion: tekton.dev/v1beta1
        kind: PipelineRun
        metadata:
          name: $PIPELINE_RUN_NAME
          namespace: $NAMESPACE
        spec:
          pipelineRef:
            name: redhat-chat-pipeline
          params:
            - name: git-url
              value: https://github.com/maximilianoPizarro/LibreChat-RedHat
            - name: git-revision
              value: main
            - name: image-name
              value: redhat-chat
            - name: image-tag
              value: latest
            - name: namespace
              value: $NAMESPACE
            - name: quay-repository
              value: maximilianopizarro/redhat-chat
          workspaces:
            - name: source
              volumeClaimTemplate:
                spec:
                  accessModes:
                    - ReadWriteOnce
                  resources:
                    requests:
                      storage: 1Gi
        EOF
        echo "✓ PipelineRun $PIPELINE_RUN_NAME created"
        echo "Monitor with: oc get pipelineruns -n $NAMESPACE -w"
        echo "View logs: oc logs -f pipelinerun/$PIPELINE_RUN_NAME -n $NAMESPACE"
  - id: deploy-expose
    exec:
      component: api
      commandLine: |
        # Use current project/namespace from workspace
        NAMESPACE=$(oc project -q 2>/dev/null || echo "${OPENSHIFT_NAMESPACE:-maximilianopizarro5-dev}")
        if [ -z "$NAMESPACE" ] || [ "$NAMESPACE" = "default" ]; then
          NAMESPACE=${OPENSHIFT_NAMESPACE:-maximilianopizarro5-dev}
        fi
        if ! oc get route redhat-chat -n $NAMESPACE &> /dev/null; then
          oc expose service redhat-chat -n $NAMESPACE
          echo "✓ Route created"
        else
          echo "✓ Route already exists"
        fi
        oc get route redhat-chat -n $NAMESPACE
  - id: deploy-status
    exec:
      component: api
      commandLine: |
        # Use current project/namespace from workspace
        NAMESPACE=$(oc project -q 2>/dev/null || echo "${OPENSHIFT_NAMESPACE:-maximilianopizarro5-dev}")
        if [ -z "$NAMESPACE" ] || [ "$NAMESPACE" = "default" ]; then
          NAMESPACE=${OPENSHIFT_NAMESPACE:-maximilianopizarro5-dev}
        fi
        echo "=== Deployment Status ==="
        oc get deployment redhat-chat -n $NAMESPACE
        echo ""
        echo "=== Pods ==="
        oc get pods -n $NAMESPACE -l app=redhat-chat
        echo ""
        echo "=== Route ==="
        oc get route redhat-chat -n $NAMESPACE 2>/dev/null || echo "Route not found"
        echo ""
        echo "=== PipelineRuns ==="
        oc get pipelineruns -n $NAMESPACE
  # Ollama model download commands - commented out due to resource constraints
  # Uncomment when Ollama component is enabled
  #- id: pull-ollama-model
  #  exec:
  #    component: ollama
  #    commandLine: |
  #      echo "Waiting for Ollama to be ready..."
  #      MAX_ATTEMPTS=30
  #      ATTEMPT=0
  #      while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
  #        if curl -s http://127.0.0.1:11434/api/tags >/dev/null 2>&1; then
  #          echo "✓ Ollama is ready"
  #          break
  #        fi
  #        ATTEMPT=$((ATTEMPT + 1))
  #        if [ $((ATTEMPT % 5)) -eq 0 ]; then
  #          echo "  Attempt $ATTEMPT/$MAX_ATTEMPTS: Ollama not ready yet, waiting..."
  #        fi
  #        sleep 2
  #      done
  #      if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
  #        echo "⚠ Warning: Ollama may not be ready, but attempting to pull model anyway..."
  #      fi
  #      echo "Pulling model llama3.2:3b-instruct-q4_K_M..."
  #      ollama pull llama3.2:3b-instruct-q4_K_M || {
  #        echo "⚠ Failed to pull model, will retry later. You can manually pull it with: ollama pull llama3.2:3b-instruct-q4_K_M"
  #        exit 0  # Don't fail the hook, allow workspace to start
  #      }
  #      echo "✓ Model pulled successfully"
  #- id: pull-autocomplete-model
  #  exec:
  #    component: ollama
  #    commandLine: |
  #      echo "Pulling autocomplete model starcoder2:3b..."
  #      ollama pull starcoder2:3b || {
  #        echo "⚠ Failed to pull autocomplete model, will retry later. You can manually pull it with: ollama pull starcoder2:3b"
  #        exit 0  # Don't fail the hook, allow workspace to start
  #      }
  #      echo "✓ Autocomplete model pulled successfully"
  - id: copy-continue-config
    exec:
      component: api
      commandLine: |
        cd /projects/librechat-redhat || cd /projects || pwd
        if [ -f continue-config.json ]; then
          echo "Copying Continue configuration..."
          mkdir -p /home/user/.continue
          cp continue-config.json /home/user/.continue/config.json
          echo "✓ Continue configuration copied to /home/user/.continue/config.json"
        else
          echo "⚠ continue-config.json not found, skipping Continue configuration"
        fi
events:
  postStart:
    - init-workspace
    # Ollama model downloads - commented out due to resource constraints
    #- pull-ollama-model
    #- pull-autocomplete-model
    - copy-continue-config
