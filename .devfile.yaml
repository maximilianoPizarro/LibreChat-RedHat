schemaVersion: 2.3.0
metadata:
  name: redhat-chat
  displayName: Red Hat Chat
  description: Red Hat Chat - Tech Preview with LibreChat and Red Hat Design System
  tags:
    - nodejs
    - chat
    - ai
    - redhat
  projectType: nodejs
  language: typescript
  version: 0.8.1-rc2
  attributes:
    tech-preview: "true"
components:
  - name: api
    container:
      image: quay.io/devfile/base-developer-image:ubi9-latest
      memoryLimit: 2Gi
      cpuLimit: 1000m
      cpuRequest: 250m
      endpoints:
        - name: http
          targetPort: 3080
          exposure: public
          protocol: http
          path: /
      env:
        - name: NODE_ENV
          value: development
        - name: HOST
          value: 0.0.0.0
        - name: PORT
          value: "3080"
        - name: DOMAIN
          value: http://localhost:3080
        - name: MONGO_URI
          value: mongodb://mongodb:27017/LibreChat
        - name: MEILI_HOST
          value: http://meilisearch:7700
        # RAG API is optional - uncomment vectordb and rag-api components to enable
        # - name: RAG_API_URL
        #   value: http://rag-api:8000
        # - name: RAG_PORT
        #   value: "8000"
        - name: JWT_EXPIRES_IN
          value: 1d
        - name: JWT_REFRESH_EXPIRES_IN
          value: 7d
      volumeMounts:
        - name: images-data
          path: /app/client/public/images
        - name: uploads-data
          path: /app/uploads
        - name: logs-data
          path: /app/api/logs
      sourceMapping: /
      command:
        - /bin/sh
        - -c
        - |
          # Keep container running
          tail -f /dev/null
  - name: mongodb
    container:
      image: docker.io/library/mongo:7.0
      memoryLimit: 512Mi
      endpoints:
        - name: mongodb
          targetPort: 27017
          exposure: none
          protocol: tcp
      command:
        - mongod
        - --noauth
      volumeMounts:
        - name: mongodb-data
          path: /data/db
  - name: meilisearch
    container:
      image: docker.io/getmeili/meilisearch:v1.12.3
      memoryLimit: 512Mi
      endpoints:
        - name: meilisearch
          targetPort: 7700
          exposure: none
          protocol: http
      env:
        - name: MEILI_HOST
          value: http://meilisearch:7700
        - name: MEILI_NO_ANALYTICS
          value: "true"
        - name: MEILI_MASTER_KEY
          value: change_me_to_a_secure_random_key_minimum_16_characters
      volumeMounts:
        - name: meili-data
          path: /meili_data
  # VectorDB and RAG API are optional - uncomment to enable RAG functionality
  # Note: VectorDB may have issues in some OpenShift environments
  # - name: vectordb
  #   container:
  #     image: docker.io/pgvector/pgvector:0.8.0-pg15-trixie
  #     memoryLimit: 1Gi
  #     cpuLimit: 500m
  #     endpoints:
  #       - name: postgres
  #         targetPort: 5432
  #         exposure: none
  #         protocol: tcp
  #     env:
  #       - name: POSTGRES_DB
  #         value: mydatabase
  #       - name: POSTGRES_USER
  #         value: myuser
  #       - name: POSTGRES_PASSWORD
  #         value: mypassword
  #     volumeMounts:
  #       - name: pg-data
  #         path: /var/lib/postgresql/data
  # - name: rag-api
  #   container:
  #     image: ghcr.io/danny-avila/librechat-rag-api-dev-lite:latest
  #     memoryLimit: 1Gi
  #     endpoints:
  #       - name: rag-api
  #         targetPort: 8000
  #         exposure: none
  #         protocol: http
  #     env:
  #       - name: DB_HOST
  #         value: vectordb
  #       - name: RAG_PORT
  #         value: "8000"
  #       - name: OPENAI_API_KEY
  #         value: ""
  - name: images-data
    volume:
      size: 1Gi
  - name: uploads-data
    volume:
      size: 1Gi
  - name: logs-data
    volume:
      size: 500Mi
  - name: mongodb-data
    volume:
      size: 2Gi
  - name: meili-data
    volume:
      size: 1Gi
  # pg-data volume - uncomment if using vectordb
  # - name: pg-data
  #   volume:
  #     size: 1Gi
commands:
  - id: init
    exec:
      component: api
      commandLine: echo "Initializing Red Hat Chat workspace..." && npm install
  - id: build
    exec:
      component: api
      commandLine: |
        cd /projects/librechat-redhat || cd /projects || pwd
        # Ensure all dependencies are installed first
        echo "Installing/updating dependencies..."
        npm install --legacy-peer-deps || npm install
        # Clean and rebuild packages to ensure peer dependencies are resolved
        echo "Cleaning previous builds..."
        rm -rf packages/client/dist packages/data-provider/dist packages/api/dist packages/data-schemas/dist
        # Build packages in correct order
        echo "Building packages..."
        npm run build:packages
        echo "Building client..."
        npm run build:client
  - id: run
    exec:
      component: api
      commandLine: |
        cd /projects/librechat-redhat || cd /projects || pwd
        if [ ! -d node_modules ] || [ ! -f node_modules/.bin/cross-env ]; then
          echo "Dependencies not installed. Installing now..."
          npm install --legacy-peer-deps || npm install
        fi
        npm run backend:dev
  - id: start
    exec:
      component: api
      commandLine: |
        cd /projects/librechat-redhat || cd /projects || pwd
        if [ ! -d node_modules ] || [ ! -f node_modules/.bin/cross-env ]; then
          echo "Dependencies not installed. Installing now..."
          npm install --legacy-peer-deps || npm install
        fi
        npm run backend:dev
  - id: init-workspace
    exec:
      component: api
      commandLine: |
        echo "Workspace container started successfully"
        echo "To initialize dependencies, run: devfile init-workspace"
        echo "To start the backend, run: devfile run"
        # Simple check - don't fail if things aren't ready
        cd /projects/librechat-redhat 2>/dev/null || cd /projects 2>/dev/null || true
        echo "Current directory: $(pwd)"
  - id: init-workspace-full
    exec:
      component: api
      commandLine: |
        echo "Initializing workspace..."
        cd /projects/librechat-redhat || cd /projects || pwd
        # Install Node.js 20 if not available
        if ! command -v node &> /dev/null || [ "$(node -v | cut -d'v' -f2 | cut -d'.' -f1)" -lt 20 ]; then
          echo "Installing Node.js 20..."
          curl -fsSL https://rpm.nodesource.com/setup_20.x | bash - || \
          (curl -fsSL https://nodejs.org/dist/v20.18.0/node-v20.18.0-linux-x64.tar.xz | tar -xJ -C /usr/local --strip-components=1)
          export PATH="/usr/local/bin:$PATH"
        fi
        # Verify Node.js and npm
        node -v && npm -v
        if [ -f package.json ]; then
          echo "Installing dependencies (this may take a few minutes)..."
          npm install --legacy-peer-deps || npm install
          if [ $? -eq 0 ]; then
            echo "✓ Dependencies installed successfully"
          else
            echo "✗ npm install failed. Please run 'npm install' manually."
            exit 1
          fi
        else
          echo "✗ package.json not found in $(pwd)"
          exit 1
        fi
        echo "✓ Workspace initialized"
        echo "Run 'devfile run' to start the backend server"
  - id: deploy-setup
    exec:
      component: api
      commandLine: |
        # Use current project/namespace from workspace, or fallback to OPENSHIFT_NAMESPACE
        NAMESPACE=$(oc project -q 2>/dev/null || echo "${OPENSHIFT_NAMESPACE:-maximilianopizarro5-dev}")
        if [ -z "$NAMESPACE" ] || [ "$NAMESPACE" = "default" ]; then
          NAMESPACE=${OPENSHIFT_NAMESPACE:-maximilianopizarro5-dev}
        fi
        echo "Setting up deployment for namespace: $NAMESPACE"
        # Ensure we're in the correct namespace
        oc project $NAMESPACE 2>/dev/null || oc create namespace $NAMESPACE
        if ! oc get secret redhat-chat-secrets -n $NAMESPACE &> /dev/null; then
          JWT_SECRET=$(openssl rand -hex 32)
          JWT_REFRESH_SECRET=$(openssl rand -hex 32)
          MEILI_MASTER_KEY=$(openssl rand -hex 16)
          oc create secret generic redhat-chat-secrets \
            --from-literal=jwt-secret=$JWT_SECRET \
            --from-literal=jwt-refresh-secret=$JWT_REFRESH_SECRET \
            --from-literal=meili-master-key=$MEILI_MASTER_KEY \
            -n $NAMESPACE
          echo "✓ Secrets created"
        else
          echo "✓ Secrets already exist"
        fi
        cd manifests/base && oc apply -k . -n $NAMESPACE && cd ../..
        echo "✓ Base manifests applied"
        oc apply -f .tekton/pipeline.yaml -n $NAMESPACE
        echo "✓ Pipeline created"
  - id: deploy-run
    exec:
      component: api
      commandLine: |
        # Use current project/namespace from workspace
        NAMESPACE=$(oc project -q 2>/dev/null || echo "${OPENSHIFT_NAMESPACE:-maximilianopizarro5-dev}")
        if [ -z "$NAMESPACE" ] || [ "$NAMESPACE" = "default" ]; then
          NAMESPACE=${OPENSHIFT_NAMESPACE:-maximilianopizarro5-dev}
        fi
        PIPELINE_RUN_NAME="redhat-chat-pipeline-run-$(date +%s)"
        cat <<EOF | oc apply -f -
        apiVersion: tekton.dev/v1beta1
        kind: PipelineRun
        metadata:
          name: $PIPELINE_RUN_NAME
          namespace: $NAMESPACE
        spec:
          pipelineRef:
            name: redhat-chat-pipeline
          params:
            - name: git-url
              value: https://github.com/maximilianoPizarro/LibreChat-RedHat
            - name: git-revision
              value: main
            - name: image-name
              value: redhat-chat
            - name: image-tag
              value: latest
            - name: namespace
              value: $NAMESPACE
            - name: quay-repository
              value: maximilianopizarro/redhat-chat
          workspaces:
            - name: source
              volumeClaimTemplate:
                spec:
                  accessModes:
                    - ReadWriteOnce
                  resources:
                    requests:
                      storage: 1Gi
        EOF
        echo "✓ PipelineRun $PIPELINE_RUN_NAME created"
        echo "Monitor with: oc get pipelineruns -n $NAMESPACE -w"
        echo "View logs: oc logs -f pipelinerun/$PIPELINE_RUN_NAME -n $NAMESPACE"
  - id: deploy-expose
    exec:
      component: api
      commandLine: |
        # Use current project/namespace from workspace
        NAMESPACE=$(oc project -q 2>/dev/null || echo "${OPENSHIFT_NAMESPACE:-maximilianopizarro5-dev}")
        if [ -z "$NAMESPACE" ] || [ "$NAMESPACE" = "default" ]; then
          NAMESPACE=${OPENSHIFT_NAMESPACE:-maximilianopizarro5-dev}
        fi
        if ! oc get route redhat-chat -n $NAMESPACE &> /dev/null; then
          oc expose service redhat-chat -n $NAMESPACE
          echo "✓ Route created"
        else
          echo "✓ Route already exists"
        fi
        oc get route redhat-chat -n $NAMESPACE
  - id: deploy-status
    exec:
      component: api
      commandLine: |
        # Use current project/namespace from workspace
        NAMESPACE=$(oc project -q 2>/dev/null || echo "${OPENSHIFT_NAMESPACE:-maximilianopizarro5-dev}")
        if [ -z "$NAMESPACE" ] || [ "$NAMESPACE" = "default" ]; then
          NAMESPACE=${OPENSHIFT_NAMESPACE:-maximilianopizarro5-dev}
        fi
        echo "=== Deployment Status ==="
        oc get deployment redhat-chat -n $NAMESPACE
        echo ""
        echo "=== Pods ==="
        oc get pods -n $NAMESPACE -l app=redhat-chat
        echo ""
        echo "=== Route ==="
        oc get route redhat-chat -n $NAMESPACE 2>/dev/null || echo "Route not found"
        echo ""
        echo "=== PipelineRuns ==="
        oc get pipelineruns -n $NAMESPACE
events:
  postStart:
    - init-workspace
